"use strict";
/*
 * Firebase Rules test simulator.
 *
 * Copyright 2015 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var chai_1 = require('chai');
var rest = require('./firebase-rest');
var util = require('./util');
var fileIO = require('./file-io');
var bolt = require('./bolt');
var generate = util.lift(bolt.generate);
var readFile = util.liftArgs(fileIO.readFile);
var MAX_TEST_MS = 60000;
;
function rulesSuite(suiteName, fnSuite) {
    new RulesSuite(suiteName, fnSuite).run();
}
exports.rulesSuite = rulesSuite;
var RulesSuite = (function () {
    function RulesSuite(suiteName, fnSuite) {
        this.suiteName = suiteName;
        this.fnSuite = fnSuite;
        this.debug = false;
        this.users = {};
        this.tests = [];
    }
    RulesSuite.prototype.setDebug = function (debug) {
        if (debug === void 0) { debug = true; }
        this.debug = debug;
        return this;
    };
    RulesSuite.prototype.run = function () {
        var self = this;
        // Run Mocha Test Suite - serialize with any other mocha test suites.
        suite("Firebase Rules Simulator: " + self.suiteName, function () {
            this.timeout(MAX_TEST_MS);
            suiteSetup(function () {
                var rulesPath = new Promise(function (resolve) {
                    self.rulesPathResolve = resolve;
                });
                var database = new Promise(function (resolve) {
                    self.databaseReady = resolve;
                });
                var rulesJSON = generate(util.getProp(readFile(rulesPath), 'content'));
                self.ready = Promise.all([rulesJSON, database])
                    .then(self.onRulesReady.bind(self));
                // Execute initialization and get test definitions (in client code).
                self.fnSuite(self.getInterface());
                return self.ready;
            });
            test("Initialization.", function () {
                // pass
            });
            test("Rules test.", function () {
                return self.runTests();
            });
        });
    };
    RulesSuite.prototype.getInterface = function () {
        var test = this.test.bind(this);
        test.rules = this.rules.bind(this);
        test.database = this.database.bind(this);
        test.uid = this.uid.bind(this);
        test.TIMESTAMP = rest.TIMESTAMP;
        return test;
    };
    // Called when rules are generated and test database is known.
    RulesSuite.prototype.onRulesReady = function (prereq) {
        var rulesJSON = prereq[0];
        return this.adminClient.put(rest.RULES_LOCATION, rulesJSON);
    };
    RulesSuite.prototype.runTests = function () {
        var p = Promise.resolve();
        function next(prev, test) {
            return prev.then(function () {
                return test.run();
            });
        }
        for (var i = 0; i < this.tests.length; i++) {
            p = next(p, this.tests[i]);
        }
        return p;
    };
    RulesSuite.prototype.test = function (testName, fnTest) {
        this.tests.push(new RulesTest(testName, this, fnTest));
    };
    RulesSuite.prototype.rules = function (rulesPath) {
        if (this.rulesPath) {
            throw new Error("Only expect a single call to the test.rules function.");
        }
        this.rulesPath = rulesPath;
        this.rulesPathResolve(util.ensureExtension(rulesPath, bolt.FILE_EXTENSION));
    };
    RulesSuite.prototype.database = function (appName, appSecret) {
        if (this.adminClient) {
            throw new Error("Only expect a single call to the test.database function.");
        }
        this.appName = appName;
        this.appSecret = appSecret;
        this.adminClient = this.ensureUser('admin');
        this.databaseReady();
    };
    RulesSuite.prototype.uid = function (username) {
        return this.ensureUser(username).uid;
    };
    RulesSuite.prototype.ensureUser = function (username) {
        if (!(username in this.users)) {
            if (username === 'anon') {
                this.users[username] = new rest.Client(this.appName);
            }
            else {
                var tokenInfo = rest.generateUidAuthToken(this.appSecret, { debug: true,
                    admin: username === 'admin' });
                this.users[username] = new rest.Client(this.appName, tokenInfo.token, tokenInfo.uid);
            }
        }
        return this.users[username];
    };
    return RulesSuite;
}());
var RulesTest = (function () {
    function RulesTest(testName, suite, fnTest) {
        this.testName = testName;
        this.suite = suite;
        this.fnTest = fnTest;
        this.steps = [];
        this.failed = false;
    }
    RulesTest.prototype.run = function () {
        var _this = this;
        this.debug(false);
        this.as('admin');
        this.at('/');
        this.write(null);
        this.succeeds("initialization");
        this.at(undefined);
        this.as('anon');
        this.fnTest(this);
        this.debug(false);
        return this.executeQueue()
            .then(function () {
            _this.log("Finished");
        })
            .catch(function (error) {
            _this.log("Failed: " + error);
            throw error;
        });
    };
    // Queue a function to be called in sequence after previous step
    // in test is (successfully) completed.
    RulesTest.prototype.queue = function (op, args, fn) {
        if (this.failed) {
            return;
        }
        var argsT = util.copyArray(args).map(function (x) {
            return util.prettyJSON(x);
        });
        var label = op + '(' + argsT.join(', ') + ')';
        this.steps.push({ label: label, fn: fn });
    };
    RulesTest.prototype.executeQueue = function () {
        var self = this;
        this.log("Executing (" + this.steps.length + " steps)");
        var p = Promise.resolve(true);
        function next(prev, step) {
            return prev.then(function () {
                self.log(step.label);
                return step.fn();
            });
        }
        for (var i = 0; i < this.steps.length; i++) {
            p = next(p, this.steps[i]);
        }
        return p;
    };
    RulesTest.prototype.debug = function (debug) {
        var _this = this;
        this.suite.setDebug(debug);
        this.queue('debug', arguments, function () {
            _this.suite.setDebug(debug);
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.as = function (username) {
        var _this = this;
        var client = this.suite.ensureUser(username);
        this.queue('as', arguments, function () {
            client.setDebug(_this.suite.debug);
            _this.client = client;
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.at = function (opPath) {
        var _this = this;
        this.queue('at', arguments, function () {
            _this.path = opPath;
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.write = function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            if (_this.path === undefined) {
                return Promise.reject(new Error("Use at() function to set path to write."));
            }
            return _this.client.put(_this.path, obj)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    };
    RulesTest.prototype.push = function (obj) {
        var _this = this;
        this.queue('write', arguments, function () {
            if (_this.path === undefined) {
                return Promise.reject(new Error("Use at() function to set path to push."));
            }
            var path = _this.path;
            if (path.slice(-1)[0] !== '/') {
                path += '/';
            }
            path += rest.generatePushID();
            return _this.client.put(path, obj)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    };
    RulesTest.prototype.read = function () {
        var _this = this;
        this.queue('read', arguments, function () {
            if (_this.path === undefined) {
                return Promise.reject(new Error("Use at() function to set path to read."));
            }
            return _this.client.get(_this.path)
                .then(function () {
                _this.status = true;
            })
                .catch(function (error) {
                _this.status = false;
                _this.lastError = error;
            });
        });
        return this;
    };
    RulesTest.prototype.succeeds = function (message) {
        var _this = this;
        this.queue('succeeds', arguments, function () {
            chai_1.assert(_this.status === true, _this.messageFormat(message + " (should have succeed)\n" + _this.lastError));
            _this.good(message);
            _this.status = undefined;
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.fails = function (message) {
        var _this = this;
        this.queue('fails', arguments, function () {
            chai_1.assert(_this.status === false, _this.messageFormat(message + " (should have failed)"));
            _this.good(message);
            _this.status = undefined;
            return Promise.resolve();
        });
        return this;
    };
    RulesTest.prototype.good = function (message) {
        this.log(message + " (Correct)");
    };
    RulesTest.prototype.log = function (message) {
        if (this.suite.debug) {
            console.log(this.messageFormat(message));
        }
    };
    RulesTest.prototype.messageFormat = function (message) {
        return this.suite.suiteName + "." + this.testName + " " + message;
    };
    return RulesTest;
}());
exports.RulesTest = RulesTest;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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R0FBRyxHQUFHLE9BQU8sQ0FBQztJQUNwRSxDQUFDO0lBQ0gsZ0JBQUM7QUFBRCxDQTNMQSxBQTJMQyxJQUFBO0FBM0xZLGlCQUFTLFlBMkxyQixDQUFBIiwiZmlsZSI6InNpbXVsYXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIEZpcmViYXNlIFJ1bGVzIHRlc3Qgc2ltdWxhdG9yLlxyXG4gKlxyXG4gKiBDb3B5cmlnaHQgMjAxNSBHb29nbGUgSW5jLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxyXG4gKlxyXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xyXG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXHJcbiAqIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxyXG4gKlxyXG4gKiAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXHJcbiAqXHJcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcclxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxyXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cclxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxyXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cclxuICovXHJcbmltcG9ydCB7YXNzZXJ0fSBmcm9tICdjaGFpJztcclxuaW1wb3J0ICogYXMgcmVzdCBmcm9tICcuL2ZpcmViYXNlLXJlc3QnO1xyXG5pbXBvcnQgKiBhcyB1dGlsIGZyb20gJy4vdXRpbCc7XHJcbmltcG9ydCAqIGFzIGZpbGVJTyBmcm9tICcuL2ZpbGUtaW8nO1xyXG5pbXBvcnQgKiBhcyBib2x0IGZyb20gJy4vYm9sdCc7XHJcblxyXG5sZXQgZ2VuZXJhdGUgPSB1dGlsLmxpZnQoYm9sdC5nZW5lcmF0ZSk7XHJcbmxldCByZWFkRmlsZSA9IHV0aWwubGlmdEFyZ3MoZmlsZUlPLnJlYWRGaWxlKTtcclxuXHJcbnZhciBNQVhfVEVTVF9NUyA9IDYwMDAwO1xyXG5cclxuZXhwb3J0IHR5cGUgU3VpdGVGdW5jdGlvbiA9IChmbjogVGVzdEZ1bmN0aW9uKSA9PiB2b2lkO1xyXG5cclxuLy8gSW50ZXJmYWNlIGZvciAndGVzdCcgZnVuY3Rpb24gcGFzc2VkIGJhY2sgdG8gcnVsZXNTdWl0ZSBjYWxsYmFjay5cclxuLy8gdGVzdCBpcyBhIGZ1bmN0aW9uIGFzIHdlbGwgYXMgYSBuYW1lc3BhY2UgZm9yIHNvbWUgc3RhdGljIG1ldGhvZHNcclxuLy8gYW5kIGNvbnN0YW50cy5cclxuZXhwb3J0IGludGVyZmFjZSBUZXN0RnVuY3Rpb24ge1xyXG4gIChuYW1lOiBzdHJpbmcsIGZuVGVzdDogKHJ1bGVzOiBSdWxlc1Rlc3QpID0+IHZvaWQpOiB2b2lkO1xyXG4gIHJ1bGVzOiAocGF0aDogc3RyaW5nKSA9PiB2b2lkO1xyXG4gIGRhdGFiYXNlOiAoYXBwTmFtZTogc3RyaW5nLCBzZWNyZXQ6IHN0cmluZykgPT4gdm9pZDtcclxuICB1aWQ6ICh1c2VybmFtZTogc3RyaW5nKSA9PiBzdHJpbmc7XHJcbiAgVElNRVNUQU1QOiBPYmplY3Q7XHJcbn07XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcnVsZXNTdWl0ZShzdWl0ZU5hbWU6IHN0cmluZywgZm5TdWl0ZTogU3VpdGVGdW5jdGlvbikge1xyXG4gIG5ldyBSdWxlc1N1aXRlKHN1aXRlTmFtZSwgZm5TdWl0ZSkucnVuKCk7XHJcbn1cclxuXHJcbmNsYXNzIFJ1bGVzU3VpdGUge1xyXG4gIHB1YmxpYyAgZGVidWcgPSBmYWxzZTtcclxuICBwcml2YXRlIHVzZXJzID0gPHtbbmFtZTogc3RyaW5nXTogcmVzdC5DbGllbnR9Pnt9O1xyXG4gIHByaXZhdGUgdGVzdHMgPSA8UnVsZXNUZXN0W10+W107XHJcbiAgcHJpdmF0ZSBydWxlc1BhdGg6IHN0cmluZztcclxuICBwcml2YXRlIHJ1bGVzUGF0aFJlc29sdmU6IChwYXRoOiBzdHJpbmcpID0+IHZvaWQ7XHJcbiAgcHJpdmF0ZSBkYXRhYmFzZVJlYWR5OiAoKSA9PiB2b2lkO1xyXG4gIHByaXZhdGUgcmVhZHk6IFByb21pc2U8YW55PjtcclxuICBwcml2YXRlIGFkbWluQ2xpZW50OiByZXN0LkNsaWVudDtcclxuICBwcml2YXRlIGFwcE5hbWU6IHN0cmluZztcclxuICBwcml2YXRlIGFwcFNlY3JldDogc3RyaW5nO1xyXG5cclxuICBjb25zdHJ1Y3RvcihwdWJsaWMgc3VpdGVOYW1lOiBzdHJpbmcsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBmblN1aXRlOiBTdWl0ZUZ1bmN0aW9uKSB7fVxyXG5cclxuICBzZXREZWJ1ZyhkZWJ1ZyA9IHRydWUpIHtcclxuICAgIHRoaXMuZGVidWcgPSBkZWJ1ZztcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgcnVuKCkge1xyXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xyXG5cclxuICAgIC8vIFJ1biBNb2NoYSBUZXN0IFN1aXRlIC0gc2VyaWFsaXplIHdpdGggYW55IG90aGVyIG1vY2hhIHRlc3Qgc3VpdGVzLlxyXG4gICAgc3VpdGUoXCJGaXJlYmFzZSBSdWxlcyBTaW11bGF0b3I6IFwiICsgc2VsZi5zdWl0ZU5hbWUsIGZ1bmN0aW9uKCkge1xyXG4gICAgICB0aGlzLnRpbWVvdXQoTUFYX1RFU1RfTVMpO1xyXG4gICAgICBzdWl0ZVNldHVwKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHZhciBydWxlc1BhdGggPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7XHJcbiAgICAgICAgICBzZWxmLnJ1bGVzUGF0aFJlc29sdmUgPSByZXNvbHZlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB2YXIgZGF0YWJhc2UgPSBuZXcgUHJvbWlzZShmdW5jdGlvbihyZXNvbHZlKSB7XHJcbiAgICAgICAgICBzZWxmLmRhdGFiYXNlUmVhZHkgPSByZXNvbHZlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB2YXIgcnVsZXNKU09OID0gZ2VuZXJhdGUodXRpbC5nZXRQcm9wKHJlYWRGaWxlKHJ1bGVzUGF0aCksICdjb250ZW50JykpO1xyXG5cclxuICAgICAgICBzZWxmLnJlYWR5ID0gUHJvbWlzZS5hbGwoW3J1bGVzSlNPTiwgZGF0YWJhc2VdKVxyXG4gICAgICAgICAgLnRoZW4oc2VsZi5vblJ1bGVzUmVhZHkuYmluZChzZWxmKSk7XHJcblxyXG4gICAgICAgIC8vIEV4ZWN1dGUgaW5pdGlhbGl6YXRpb24gYW5kIGdldCB0ZXN0IGRlZmluaXRpb25zIChpbiBjbGllbnQgY29kZSkuXHJcbiAgICAgICAgc2VsZi5mblN1aXRlKHNlbGYuZ2V0SW50ZXJmYWNlKCkpO1xyXG5cclxuICAgICAgICByZXR1cm4gc2VsZi5yZWFkeTtcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0ZXN0KFwiSW5pdGlhbGl6YXRpb24uXCIsIGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIC8vIHBhc3NcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0ZXN0KFwiUnVsZXMgdGVzdC5cIiwgZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgcmV0dXJuIHNlbGYucnVuVGVzdHMoKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldEludGVyZmFjZSgpIHtcclxuICAgIHZhciB0ZXN0ID0gdGhpcy50ZXN0LmJpbmQodGhpcyk7XHJcbiAgICB0ZXN0LnJ1bGVzID0gdGhpcy5ydWxlcy5iaW5kKHRoaXMpO1xyXG4gICAgdGVzdC5kYXRhYmFzZSA9IHRoaXMuZGF0YWJhc2UuYmluZCh0aGlzKTtcclxuICAgIHRlc3QudWlkID0gdGhpcy51aWQuYmluZCh0aGlzKTtcclxuICAgIHRlc3QuVElNRVNUQU1QID0gcmVzdC5USU1FU1RBTVA7XHJcbiAgICByZXR1cm4gdGVzdDtcclxuICB9XHJcblxyXG4gIC8vIENhbGxlZCB3aGVuIHJ1bGVzIGFyZSBnZW5lcmF0ZWQgYW5kIHRlc3QgZGF0YWJhc2UgaXMga25vd24uXHJcbiAgb25SdWxlc1JlYWR5KHByZXJlcTogW09iamVjdCwgYW55XSkge1xyXG4gICAgbGV0IHJ1bGVzSlNPTiA9IHByZXJlcVswXTtcclxuICAgIHJldHVybiB0aGlzLmFkbWluQ2xpZW50LnB1dChyZXN0LlJVTEVTX0xPQ0FUSU9OLCBydWxlc0pTT04pO1xyXG4gIH1cclxuXHJcbiAgcnVuVGVzdHMoKSB7XHJcbiAgICB2YXIgcCA9IFByb21pc2UucmVzb2x2ZSgpO1xyXG5cclxuICAgIGZ1bmN0aW9uIG5leHQocHJldjogUHJvbWlzZTxhbnk+LCB0ZXN0OiBSdWxlc1Rlc3QpOiBQcm9taXNlPGFueT4ge1xyXG4gICAgICByZXR1cm4gcHJldi50aGVuKGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB0ZXN0LnJ1bigpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudGVzdHMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgcCA9IG5leHQocCwgdGhpcy50ZXN0c1tpXSk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHA7XHJcbiAgfVxyXG5cclxuICB0ZXN0KHRlc3ROYW1lOiBzdHJpbmcsIGZuVGVzdDogKHJ1bGVzOiBSdWxlc1Rlc3QpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgIHRoaXMudGVzdHMucHVzaChuZXcgUnVsZXNUZXN0KHRlc3ROYW1lLCB0aGlzLCBmblRlc3QpKTtcclxuICB9XHJcblxyXG4gIHJ1bGVzKHJ1bGVzUGF0aDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5ydWxlc1BhdGgpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiT25seSBleHBlY3QgYSBzaW5nbGUgY2FsbCB0byB0aGUgdGVzdC5ydWxlcyBmdW5jdGlvbi5cIik7XHJcbiAgICB9XHJcbiAgICB0aGlzLnJ1bGVzUGF0aCA9IHJ1bGVzUGF0aDtcclxuICAgIHRoaXMucnVsZXNQYXRoUmVzb2x2ZSh1dGlsLmVuc3VyZUV4dGVuc2lvbihydWxlc1BhdGgsIGJvbHQuRklMRV9FWFRFTlNJT04pKTtcclxuICB9XHJcblxyXG4gIGRhdGFiYXNlKGFwcE5hbWU6IHN0cmluZywgYXBwU2VjcmV0OiBzdHJpbmcpIHtcclxuICAgIGlmICh0aGlzLmFkbWluQ2xpZW50KSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIk9ubHkgZXhwZWN0IGEgc2luZ2xlIGNhbGwgdG8gdGhlIHRlc3QuZGF0YWJhc2UgZnVuY3Rpb24uXCIpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5hcHBOYW1lID0gYXBwTmFtZTtcclxuICAgIHRoaXMuYXBwU2VjcmV0ID0gYXBwU2VjcmV0O1xyXG4gICAgdGhpcy5hZG1pbkNsaWVudCA9IHRoaXMuZW5zdXJlVXNlcignYWRtaW4nKTtcclxuICAgIHRoaXMuZGF0YWJhc2VSZWFkeSgpO1xyXG4gIH1cclxuXHJcbiAgdWlkKHVzZXJuYW1lOiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xyXG4gICAgcmV0dXJuIHRoaXMuZW5zdXJlVXNlcih1c2VybmFtZSkudWlkO1xyXG4gIH1cclxuXHJcbiAgZW5zdXJlVXNlcih1c2VybmFtZTogc3RyaW5nKTogcmVzdC5DbGllbnQge1xyXG4gICAgaWYgKCEodXNlcm5hbWUgaW4gdGhpcy51c2VycykpIHtcclxuICAgICAgaWYgKHVzZXJuYW1lID09PSAnYW5vbicpIHtcclxuICAgICAgICB0aGlzLnVzZXJzW3VzZXJuYW1lXSA9IG5ldyByZXN0LkNsaWVudCh0aGlzLmFwcE5hbWUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGxldCB0b2tlbkluZm8gPSByZXN0LmdlbmVyYXRlVWlkQXV0aFRva2VuKFxyXG4gICAgICAgICAgdGhpcy5hcHBTZWNyZXQsXHJcbiAgICAgICAgICB7IGRlYnVnOiB0cnVlLFxyXG4gICAgICAgICAgICBhZG1pbjogdXNlcm5hbWUgPT09ICdhZG1pbicgfSk7XHJcbiAgICAgICAgdGhpcy51c2Vyc1t1c2VybmFtZV0gPSBuZXcgcmVzdC5DbGllbnQodGhpcy5hcHBOYW1lLCB0b2tlbkluZm8udG9rZW4sIHRva2VuSW5mby51aWQpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXMudXNlcnNbdXNlcm5hbWVdO1xyXG4gIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIFN0ZXAge1xyXG4gIGxhYmVsOiBzdHJpbmc7XHJcbiAgZm46ICgpID0+IFByb21pc2U8YW55PjtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFJ1bGVzVGVzdCB7XHJcbiAgcHJpdmF0ZSBsYXN0RXJyb3I6IHN0cmluZztcclxuICBwcml2YXRlIHN0ZXBzOiBTdGVwW10gPSBbXTtcclxuICBwcml2YXRlIGZhaWxlZCA9IGZhbHNlO1xyXG4gIHByaXZhdGUgcGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkO1xyXG4gIHByaXZhdGUgY2xpZW50OiByZXN0LkNsaWVudDtcclxuICBwcml2YXRlIHN0YXR1czogYm9vbGVhbiB8IHVuZGVmaW5lZDtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSB0ZXN0TmFtZTogc3RyaW5nLFxyXG4gICAgICAgICAgICAgIHByaXZhdGUgc3VpdGU6IFJ1bGVzU3VpdGUsXHJcbiAgICAgICAgICAgICAgcHJpdmF0ZSBmblRlc3Q6IChydWxlczogUnVsZXNUZXN0KSA9PiB2b2lkKSB7fVxyXG5cclxuICBydW4oKSB7XHJcbiAgICB0aGlzLmRlYnVnKGZhbHNlKTtcclxuICAgIHRoaXMuYXMoJ2FkbWluJyk7XHJcbiAgICB0aGlzLmF0KCcvJyk7XHJcbiAgICB0aGlzLndyaXRlKG51bGwpO1xyXG4gICAgdGhpcy5zdWNjZWVkcyhcImluaXRpYWxpemF0aW9uXCIpO1xyXG5cclxuICAgIHRoaXMuYXQodW5kZWZpbmVkKTtcclxuICAgIHRoaXMuYXMoJ2Fub24nKTtcclxuXHJcbiAgICB0aGlzLmZuVGVzdCh0aGlzKTtcclxuXHJcbiAgICB0aGlzLmRlYnVnKGZhbHNlKTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5leGVjdXRlUXVldWUoKVxyXG4gICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJGaW5pc2hlZFwiKTtcclxuICAgICAgfSlcclxuICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgIHRoaXMubG9nKFwiRmFpbGVkOiBcIiArIGVycm9yKTtcclxuICAgICAgICB0aHJvdyBlcnJvcjtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyBRdWV1ZSBhIGZ1bmN0aW9uIHRvIGJlIGNhbGxlZCBpbiBzZXF1ZW5jZSBhZnRlciBwcmV2aW91cyBzdGVwXHJcbiAgLy8gaW4gdGVzdCBpcyAoc3VjY2Vzc2Z1bGx5KSBjb21wbGV0ZWQuXHJcbiAgcXVldWUob3A6IHN0cmluZywgYXJnczogQXJyYXlMaWtlPGFueT4sIGZuOiAoKSA9PiBQcm9taXNlPGFueT4pIHtcclxuICAgIGlmICh0aGlzLmZhaWxlZCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcbiAgICBsZXQgYXJnc1QgPSB1dGlsLmNvcHlBcnJheShhcmdzKS5tYXAoZnVuY3Rpb24oeCkge1xyXG4gICAgICByZXR1cm4gdXRpbC5wcmV0dHlKU09OKHgpO1xyXG4gICAgfSk7XHJcbiAgICB2YXIgbGFiZWwgPSBvcCArICcoJyArIGFyZ3NULmpvaW4oJywgJykgKyAnKSc7XHJcbiAgICB0aGlzLnN0ZXBzLnB1c2goe2xhYmVsOiBsYWJlbCwgZm46IGZufSk7XHJcbiAgfVxyXG5cclxuICBleGVjdXRlUXVldWUoKSB7XHJcbiAgICB2YXIgc2VsZiA9IHRoaXM7XHJcblxyXG4gICAgdGhpcy5sb2coXCJFeGVjdXRpbmcgKFwiICsgdGhpcy5zdGVwcy5sZW5ndGggKyBcIiBzdGVwcylcIik7XHJcbiAgICB2YXIgcCA9IFByb21pc2UucmVzb2x2ZSh0cnVlKTtcclxuXHJcbiAgICBmdW5jdGlvbiBuZXh0KHByZXY6IFByb21pc2U8YW55Piwgc3RlcDogU3RlcCk6IFByb21pc2U8YW55PiB7XHJcbiAgICAgIHJldHVybiBwcmV2LnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgc2VsZi5sb2coc3RlcC5sYWJlbCk7XHJcbiAgICAgICAgcmV0dXJuIHN0ZXAuZm4oKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnN0ZXBzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgIHAgPSBuZXh0KHAsIHRoaXMuc3RlcHNbaV0pO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBwO1xyXG4gIH1cclxuXHJcbiAgZGVidWcoZGVidWc/OiBib29sZWFuKTogUnVsZXNUZXN0IHtcclxuICAgIHRoaXMuc3VpdGUuc2V0RGVidWcoZGVidWcpO1xyXG4gICAgdGhpcy5xdWV1ZSgnZGVidWcnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgdGhpcy5zdWl0ZS5zZXREZWJ1ZyhkZWJ1Zyk7XHJcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfVxyXG5cclxuICBhcyh1c2VybmFtZTogc3RyaW5nKTogUnVsZXNUZXN0IHtcclxuICAgIHZhciBjbGllbnQgPSB0aGlzLnN1aXRlLmVuc3VyZVVzZXIodXNlcm5hbWUpO1xyXG4gICAgdGhpcy5xdWV1ZSgnYXMnLCBhcmd1bWVudHMsICgpID0+IHtcclxuICAgICAgY2xpZW50LnNldERlYnVnKHRoaXMuc3VpdGUuZGVidWcpO1xyXG4gICAgICB0aGlzLmNsaWVudCA9IGNsaWVudDtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIGF0KG9wUGF0aDogc3RyaW5nIHwgdW5kZWZpbmVkKTogUnVsZXNUZXN0IHtcclxuICAgIHRoaXMucXVldWUoJ2F0JywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIHRoaXMucGF0aCA9IG9wUGF0aDtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIHdyaXRlKG9iajogYW55KTogUnVsZXNUZXN0IHtcclxuICAgIHRoaXMucXVldWUoJ3dyaXRlJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLnBhdGggPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoXCJVc2UgYXQoKSBmdW5jdGlvbiB0byBzZXQgcGF0aCB0byB3cml0ZS5cIikpO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0aGlzLmNsaWVudC5wdXQodGhpcy5wYXRoLCBvYmopXHJcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSB0cnVlO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSBmYWxzZTtcclxuICAgICAgICAgIHRoaXMubGFzdEVycm9yID0gZXJyb3I7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgcHVzaChvYmo6IGFueSk6IFJ1bGVzVGVzdCB7XHJcbiAgICB0aGlzLnF1ZXVlKCd3cml0ZScsIGFyZ3VtZW50cywgKCkgPT4ge1xyXG4gICAgICBpZiAodGhpcy5wYXRoID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFwiVXNlIGF0KCkgZnVuY3Rpb24gdG8gc2V0IHBhdGggdG8gcHVzaC5cIikpO1xyXG4gICAgICB9XHJcbiAgICAgIGxldCBwYXRoID0gdGhpcy5wYXRoO1xyXG4gICAgICBpZiAocGF0aC5zbGljZSgtMSlbMF0gIT09ICcvJykge1xyXG4gICAgICAgIHBhdGggKz0gJy8nO1xyXG4gICAgICB9XHJcbiAgICAgIHBhdGggKz0gcmVzdC5nZW5lcmF0ZVB1c2hJRCgpO1xyXG4gICAgICByZXR1cm4gdGhpcy5jbGllbnQucHV0KHBhdGgsIG9iailcclxuICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IHRydWU7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnN0YXR1cyA9IGZhbHNlO1xyXG4gICAgICAgICAgdGhpcy5sYXN0RXJyb3IgPSBlcnJvcjtcclxuICAgICAgICB9KTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfVxyXG5cclxuICByZWFkKCk6IFJ1bGVzVGVzdCB7XHJcbiAgICB0aGlzLnF1ZXVlKCdyZWFkJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIGlmICh0aGlzLnBhdGggPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChuZXcgRXJyb3IoXCJVc2UgYXQoKSBmdW5jdGlvbiB0byBzZXQgcGF0aCB0byByZWFkLlwiKSk7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRoaXMuY2xpZW50LmdldCh0aGlzLnBhdGgpXHJcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSB0cnVlO1xyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLmNhdGNoKChlcnJvcikgPT4ge1xyXG4gICAgICAgICAgdGhpcy5zdGF0dXMgPSBmYWxzZTtcclxuICAgICAgICAgIHRoaXMubGFzdEVycm9yID0gZXJyb3I7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgc3VjY2VlZHMobWVzc2FnZTogc3RyaW5nKTogUnVsZXNUZXN0IHtcclxuICAgIHRoaXMucXVldWUoJ3N1Y2NlZWRzJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIGFzc2VydCh0aGlzLnN0YXR1cyA9PT0gdHJ1ZSxcclxuICAgICAgICAgICAgIHRoaXMubWVzc2FnZUZvcm1hdChtZXNzYWdlICsgXCIgKHNob3VsZCBoYXZlIHN1Y2NlZWQpXFxuXCIgKyB0aGlzLmxhc3RFcnJvcikpO1xyXG4gICAgICB0aGlzLmdvb2QobWVzc2FnZSk7XHJcbiAgICAgIHRoaXMuc3RhdHVzID0gdW5kZWZpbmVkO1xyXG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgZmFpbHMobWVzc2FnZTogc3RyaW5nKTogUnVsZXNUZXN0IHtcclxuICAgIHRoaXMucXVldWUoJ2ZhaWxzJywgYXJndW1lbnRzLCAoKSA9PiB7XHJcbiAgICAgIGFzc2VydCh0aGlzLnN0YXR1cyA9PT0gZmFsc2UsXHJcbiAgICAgICAgICAgICB0aGlzLm1lc3NhZ2VGb3JtYXQobWVzc2FnZSArIFwiIChzaG91bGQgaGF2ZSBmYWlsZWQpXCIpKTtcclxuICAgICAgdGhpcy5nb29kKG1lc3NhZ2UpO1xyXG4gICAgICB0aGlzLnN0YXR1cyA9IHVuZGVmaW5lZDtcclxuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ29vZChtZXNzYWdlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMubG9nKG1lc3NhZ2UgKyBcIiAoQ29ycmVjdClcIik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGxvZyhtZXNzYWdlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLnN1aXRlLmRlYnVnKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKHRoaXMubWVzc2FnZUZvcm1hdChtZXNzYWdlKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBtZXNzYWdlRm9ybWF0KG1lc3NhZ2U6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5zdWl0ZS5zdWl0ZU5hbWUgKyBcIi5cIiArIHRoaXMudGVzdE5hbWUgKyBcIiBcIiArIG1lc3NhZ2U7XHJcbiAgfVxyXG59XHJcbiJdfQ==
