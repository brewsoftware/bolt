/*
 * Copyright 2015 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
"use strict";
var util = require('../util');
var ast = require('../ast');
var logger = require('../logger');
;
/*
 * Run data drive test with tests is one of these formats:
 * [ { label: (opt) <string>, data: <input>, expect: (opt) <expected output> }, ... ]
 * [ [ <input>, <expected output> ], ... ]
 * [ scalar, ... ]
 *
 * Calls testIt(data, expect) for each test.
 */
function dataDrivenTest(tests, testIt, formatter) {
    if (formatter === void 0) { formatter = format; }
    var data;
    var expect;
    var label;
    for (var i = 0; i < tests.length; i++) {
        // Not Array or Object
        if (typeof tests[i] !== 'object') {
            label = formatter(tests[i]);
            data = tests[i];
            expect = undefined;
        }
        else {
            data = tests[i].data;
            if (data === undefined) {
                data = tests[i][0];
            }
            if (data === undefined) {
                data = tests[i];
            }
            if (util.isType(data, 'object') && 'expect' in data) {
                data = util.extend({}, data);
                delete data.expect;
            }
            expect = tests[i].expect || tests[i][1];
            label = tests[i].label;
            if (label === undefined) {
                if (expect !== undefined) {
                    label = formatter(data) + " => " + formatter(expect);
                }
                else {
                    label = formatter(data);
                }
            }
        }
        setup(function () {
            logger.reset();
            logger.silent();
        });
        teardown(function () {
            logger.reset();
        });
        test(label, testIt.bind(undefined, data, expect, tests[i]));
    }
}
exports.dataDrivenTest = dataDrivenTest;
function format(o) {
    switch (util.typeOf(o)) {
        case 'regexp':
            return o.toString();
        default:
            return JSON.stringify(o);
    }
}
function expFormat(x) {
    if (util.isType(x, 'array')) {
        return '[' + x.map(expFormat).join(', ') + ']';
    }
    if (util.isType(x, 'object')) {
        if ('type' in x) {
            return ast.decodeExpression(x);
        }
        var result = '{';
        var sep = '';
        for (var prop in x) {
            if (!x.hasOwnProperty(prop)) {
                continue;
            }
            result += sep + expFormat(x[prop]);
            sep = ', ';
        }
        result += '}';
        return result;
    }
    return JSON.stringify(x);
}
exports.expFormat = expFormat;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdGVzdC1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7O0FBRUgsSUFBWSxJQUFJLFdBQU0sU0FBUyxDQUFDLENBQUE7QUFDaEMsSUFBWSxHQUFHLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDOUIsSUFBWSxNQUFNLFdBQU0sV0FBVyxDQUFDLENBQUE7QUFNbkMsQ0FBQztBQVlGOzs7Ozs7O0dBT0c7QUFDSCx3QkFBK0IsS0FBYSxFQUFFLE1BQW9CLEVBQUUsU0FBa0I7SUFBbEIseUJBQWtCLEdBQWxCLGtCQUFrQjtJQUNwRixJQUFJLElBQVMsQ0FBQztJQUNkLElBQUksTUFBVyxDQUFDO0lBQ2hCLElBQUksS0FBYSxDQUFDO0lBRWxCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3RDLHNCQUFzQjtRQUN0QixFQUFFLENBQUMsQ0FBQyxPQUFPLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQ2pDLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUIsSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoQixNQUFNLEdBQUcsU0FBUyxDQUFDO1FBQ3JCLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3JCLEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUN2QixJQUFJLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLENBQUM7WUFDRCxFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENB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QkFDNUIsUUFBUSxDQUFDO1lBQ1gsQ0FBQztZQUNELE1BQU0sSUFBSSxHQUFHLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ25DLEdBQUcsR0FBRyxJQUFJLENBQUM7UUFDYixDQUFDO1FBQ0QsTUFBTSxJQUFJLEdBQUcsQ0FBQztRQUNkLE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNCLENBQUM7QUFyQmUsaUJBQVMsWUFxQnhCLENBQUEiLCJmaWxlIjoidGVzdC90ZXN0LWhlbHBlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbiAqIENvcHlyaWdodCAyMDE1IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXHJcbiAqXHJcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XHJcbiAqIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cclxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XHJcbiAqXHJcbiAqICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcclxuICpcclxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxyXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXHJcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxyXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXHJcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxyXG4gKi9cclxuXHJcbmltcG9ydCAqIGFzIHV0aWwgZnJvbSAnLi4vdXRpbCc7XHJcbmltcG9ydCAqIGFzIGFzdCBmcm9tICcuLi9hc3QnO1xyXG5pbXBvcnQgKiBhcyBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgT2JqZWN0U3BlYyB7XHJcbiAgbGFiZWw/OiBzdHJpbmc7XHJcbiAgZGF0YTogYW55O1xyXG4gIGV4cGVjdD86IGFueTtcclxufTtcclxuXHJcbmV4cG9ydCB0eXBlIEFycmF5U3BlYyA9IFthbnksIGFueV07XHJcblxyXG5leHBvcnQgdHlwZSBWYWx1ZVNwZWMgPSBhbnk7XHJcblxyXG5leHBvcnQgdHlwZSBTcGVjID0gT2JqZWN0U3BlYyB8IEFycmF5U3BlYyB8IFZhbHVlU3BlYztcclxuXHJcbmV4cG9ydCB0eXBlIFRlc3RGdW5jdGlvbiA9IChkYXRhOiBhbnksIGV4cGVjdDogYW55LCBzcGVjOiBTcGVjKSA9PiB2b2lkO1xyXG5cclxuZXhwb3J0IHR5cGUgRm9ybWF0RnVuY3Rpb24gPSAoZGF0YTogYW55KSA9PiBzdHJpbmc7XHJcblxyXG4vKlxyXG4gKiBSdW4gZGF0YSBkcml2ZSB0ZXN0IHdpdGggdGVzdHMgaXMgb25lIG9mIHRoZXNlIGZvcm1hdHM6XHJcbiAqIFsgeyBsYWJlbDogKG9wdCkgPHN0cmluZz4sIGRhdGE6IDxpbnB1dD4sIGV4cGVjdDogKG9wdCkgPGV4cGVjdGVkIG91dHB1dD4gfSwgLi4uIF1cclxuICogWyBbIDxpbnB1dD4sIDxleHBlY3RlZCBvdXRwdXQ+IF0sIC4uLiBdXHJcbiAqIFsgc2NhbGFyLCAuLi4gXVxyXG4gKlxyXG4gKiBDYWxscyB0ZXN0SXQoZGF0YSwgZXhwZWN0KSBmb3IgZWFjaCB0ZXN0LlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGRhdGFEcml2ZW5UZXN0KHRlc3RzOiBTcGVjW10sIHRlc3RJdDogVGVzdEZ1bmN0aW9uLCBmb3JtYXR0ZXIgPSBmb3JtYXQpIHtcclxuICB2YXIgZGF0YTogYW55O1xyXG4gIHZhciBleHBlY3Q6IGFueTtcclxuICB2YXIgbGFiZWw6IHN0cmluZztcclxuXHJcbiAgZm9yICh2YXIgaSA9IDA7IGkgPCB0ZXN0cy5sZW5ndGg7IGkrKykge1xyXG4gICAgLy8gTm90IEFycmF5IG9yIE9iamVjdFxyXG4gICAgaWYgKHR5cGVvZiB0ZXN0c1tpXSAhPT0gJ29iamVjdCcpIHtcclxuICAgICAgbGFiZWwgPSBmb3JtYXR0ZXIodGVzdHNbaV0pO1xyXG4gICAgICBkYXRhID0gdGVzdHNbaV07XHJcbiAgICAgIGV4cGVjdCA9IHVuZGVmaW5lZDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGRhdGEgPSB0ZXN0c1tpXS5kYXRhO1xyXG4gICAgICBpZiAoZGF0YSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgZGF0YSA9IHRlc3RzW2ldWzBdO1xyXG4gICAgICB9XHJcbiAgICAgIGlmIChkYXRhID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICBkYXRhID0gdGVzdHNbaV07XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHV0aWwuaXNUeXBlKGRhdGEsICdvYmplY3QnKSAmJiAnZXhwZWN0JyBpbiBkYXRhKSB7XHJcbiAgICAgICAgZGF0YSA9IHV0aWwuZXh0ZW5kKHt9LCBkYXRhKTtcclxuICAgICAgICBkZWxldGUgZGF0YS5leHBlY3Q7XHJcbiAgICAgIH1cclxuICAgICAgZXhwZWN0ID0gdGVzdHNbaV0uZXhwZWN0IHx8IHRlc3RzW2ldWzFdO1xyXG4gICAgICBsYWJlbCA9IHRlc3RzW2ldLmxhYmVsO1xyXG4gICAgICBpZiAobGFiZWwgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIGlmIChleHBlY3QgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgbGFiZWwgPSBmb3JtYXR0ZXIoZGF0YSkgKyBcIiA9PiBcIiArIGZvcm1hdHRlcihleHBlY3QpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBsYWJlbCA9IGZvcm1hdHRlcihkYXRhKTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZXR1cCgoKSA9PiB7XHJcbiAgICAgIGxvZ2dlci5yZXNldCgpO1xyXG4gICAgICBsb2dnZXIuc2lsZW50KCk7XHJcbiAgICB9KTtcclxuICAgIHRlYXJkb3duKCgpID0+IHtcclxuICAgICAgbG9nZ2VyLnJlc2V0KCk7XHJcbiAgICB9KTtcclxuICAgIHRlc3QobGFiZWwsIHRlc3RJdC5iaW5kKHVuZGVmaW5lZCwgZGF0YSwgZXhwZWN0LCB0ZXN0c1tpXSkpO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZm9ybWF0KG86IGFueSk6IHN0cmluZyB7XHJcbiAgc3dpdGNoICh1dGlsLnR5cGVPZihvKSkge1xyXG4gIGNhc2UgJ3JlZ2V4cCc6XHJcbiAgICByZXR1cm4gby50b1N0cmluZygpO1xyXG4gIGRlZmF1bHQ6XHJcbiAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkobyk7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhwRm9ybWF0KHg6IGFueSk6IHN0cmluZyB7XHJcbiAgaWYgKHV0aWwuaXNUeXBlKHgsICdhcnJheScpKSB7XHJcbiAgICByZXR1cm4gJ1snICsgeC5tYXAoZXhwRm9ybWF0KS5qb2luKCcsICcpICsgJ10nO1xyXG4gIH1cclxuICBpZiAodXRpbC5pc1R5cGUoeCwgJ29iamVjdCcpKSB7XHJcbiAgICBpZiAoJ3R5cGUnIGluIHgpIHtcclxuICAgICAgcmV0dXJuIGFzdC5kZWNvZGVFeHByZXNzaW9uKHgpO1xyXG4gICAgfVxyXG4gICAgdmFyIHJlc3VsdCA9ICd7JztcclxuICAgIHZhciBzZXAgPSAnJztcclxuICAgIGZvciAodmFyIHByb3AgaW4geCkge1xyXG4gICAgICBpZiAoIXguaGFzT3duUHJvcGVydHkocHJvcCkpIHtcclxuICAgICAgICBjb250aW51ZTtcclxuICAgICAgfVxyXG4gICAgICByZXN1bHQgKz0gc2VwICsgZXhwRm9ybWF0KHhbcHJvcF0pO1xyXG4gICAgICBzZXAgPSAnLCAnO1xyXG4gICAgfVxyXG4gICAgcmVzdWx0ICs9ICd9JztcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbiAgfVxyXG4gIHJldHVybiBKU09OLnN0cmluZ2lmeSh4KTtcclxufVxyXG4iXX0=
